# 2.2 chatbot实践（基于规则的）

经典案例：ELIZA。识别关键词→应用预设转换规则→将描述转为提问。

## 2.2.2 模式匹配（pattern match）与文本替换（text substitution）

1. 关键词识别和排序：规则库为每个关键词（如 mother, dreamed, depressed）设定一个优先级。包含多个关键词时选优先级最高进行处理。
2. 分解规则：程序使用带通配符（\*）的分解规则来捕获句子的其余部分。*意思就是用通配符把关键词和关键词以外的部分分别提取出来。*
	- 规则示例： \* my \*
		1. **此处my就是关键词**；，关键词通常是规则里的固定词，通配符 \* 是用来匹配 “非关键的上下文”
		2. 分解规则 * my * 的结构可以看作：[通配符1] + [固定词my] + [通配符2]，截取关键词左右两侧的内容；如果是“I love my mother”，那分解结果就是： ["I love ", "mother"]。
	- 用户输入： "My mother is afraid of me"
	- 捕获结果： ["", "mother is afraid of me"]
3. 重组规则：程序从与分解规则关联的一组重组规则中，选择一条来生成回应（通常随机选择以增加多样性），并可选择性地使用上一步捕获的内容。
	1. 不使用捕获内容（固定回应）：不管分解规则捕获到的内容是 ["", "mother is afraid of me"] 还是别的，只要触发了对应的分解规则，就直接输出“Tell me more about your family.” 即**围绕关键词（my）展开固定话题**。
	2. 复用捕获内容（动态回应）：
		1. 捕获结果：["I love ", "mother"]（用户输入是 I love my mother）
		2. 重组规则模板：Why do you love \*? → 这里的 \* 就是占位符，专门填分解捕获的内容
		3. 把捕获的第二个通配符内容 mother 填进去，最终输出：Why do you love mother?
	3. 代词转换：重组前的代词转换（I→you、my→your）是为了让回应更符合对话逻辑。

总结：分解规则是 “拆输入”，重组规则是 “拼输出”。



## 2.2.3 实践

简易逻辑实现：

```python
import re
import random

# 定义规则库:模式(正则表达式) -> 响应模板列表
rules = {
    r'I need (.*)': [
        "Why do you need {0}?",
        "Would it really help you to get {0}?",
        "Are you sure you need {0}?"
    ],
    r'Why don\'t you (.*)\?': [
        "Do you really think I don't {0}?",
        "Perhaps eventually I will {0}.",
        "Do you really want me to {0}?"
    ],
    r'Why can\'t I (.*)\?': [
        "Do you think you should be able to {0}?",
        "If you could {0}, what would you do?",
        "I don't know -- why can't you {0}?"
    ],
    r'I am (.*)': [
        "Did you come to me because you are {0}?",
        "How long have you been {0}?",
        "How do you feel about being {0}?"
    ],
    r'.* mother .*': [
        "Tell me more about your mother.",
        "What was your relationship with your mother like?",
        "How do you feel about your mother?"
    ],
    r'.* father .*': [
        "Tell me more about your father.",
        "How did your father make you feel?",
        "What has your father taught you?"
    ],
    r'.*': [
        "Please tell me more.",
        "Let's change focus a bit... Tell me about your family.",
        "Can you elaborate on that?"
    ]
}

# 定义代词转换规则
pronoun_swap = {
    "i": "you", "you": "i", "me": "you", "my": "your",
    "am": "are", "are": "am", "was": "were", "i'd": "you would",
    "i've": "you have", "i'll": "you will", "yours": "mine",
    "mine": "yours"
}

def swap_pronouns(phrase):
    """
    对输入短语中的代词进行第一/第二人称转换
    """
    words = phrase.lower().split()
    swapped_words = [pronoun_swap.get(word, word) for word in words]
    return " ".join(swapped_words)

def respond(user_input):
    """
    根据规则库生成响应
    """
    for pattern, responses in rules.items():
        match = re.search(pattern, user_input, re.IGNORECASE)
        if match:
            # 捕获匹配到的部分
            captured_group = match.group(1) if match.groups() else ''
            # 进行代词转换
            swapped_group = swap_pronouns(captured_group)
            # 从模板中随机选择一个并格式化
            response = random.choice(responses).format(swapped_group)
            return response
    # 如果没有匹配任何特定规则，使用最后的通配符规则
    return random.choice(rules[r'.*'])

# 主聊天循环
if __name__ == '__main__':
    print("Therapist: Hello! How can I help you today?")
    while True:
        user_input = input("You: ")
        if user_input.lower() in ["quit", "exit", "bye"]:
            print("Therapist: Goodbye. It was nice talking to you.")
            break
        response = respond(user_input)
        print(f"Therapist: {response}")
        
>>>
Therapist: Hello! How can I help you today?
You: I am feeling sad today.
Therapist: How long have you been feeling sad today?
You: I need some help with my project.
Therapist: Are you sure you need some help with your project?
You: My mother is not happy with my work.
Therapist: Tell me more about your mother.
You: quit
Therapist: Goodbye. It was nice talking to you.

```

缺点：
1. 缺乏语义理解
2. 无上下文记忆
3. 规则扩展很麻烦，很难维护和整理


